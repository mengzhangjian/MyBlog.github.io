---
layout:     post
title:      è§£ç çš„ç”Ÿæˆå¤šæ ·æ€§
subtitle:   æ˜¯å¤§æ¨¡å‹å‘€
date:       2023-08-14
author:     BY    J
header-img: img/post-bg-mma-4.jpg
catalog: true
tags:
    - å¤§æ¨¡å‹
---
# è§£ç çš„ç”Ÿæˆå¤šæ ·æ€§

åŸæ–‡å‡ºå¤„:

- [https://huggingface.co/docs/transformers/v4.18.0/en/main_classes/text_generation](https://huggingface.co/docs/transformers/v4.18.0/en/main_classes/text_generation)
- [https://huggingface.co/blog/zh/how-to-generate](https://huggingface.co/blog/zh/how-to-generate)

å¯¹äºè‡ªå›å½’æ–‡æœ¬ç”Ÿæˆä»»åŠ¡ä¸­çš„é¢„è®­ç»ƒæ¨¡å‹ï¼Œæ¯ä¸€ä¸ªæ¡†æ¶éƒ½æœ‰å¯¹åº”çš„generateç”Ÿæˆæ–¹æ³•ï¼Œä¸€èˆ¬å°è£…åœ¨å„è‡ªçš„GnenerationMixin classä¸­ã€‚

è¿™ä¸ªç±»å¯¹å¤–æä¾›generate()æ–¹æ³•ï¼Œå¯ä»¥ç”¨äº:

- greedy decoding: å½“num_beams=1ä¸”do_sample=Falseï¼Œè°ƒç”¨greedy_search()æ–¹æ³•
- multinomial: å½“num_beams=1ä¸”do_sample=Trueï¼Œè°ƒç”¨sample()æ–¹æ³•
- beam-search: å½“num_beams > 1ä¸”do_sample=Falseï¼Œ è°ƒç”¨beam_search()æ–¹æ³•
- beam-search multinomial: å½“ num_beams > 1ä¸”do_sample=Trueï¼Œè°ƒç”¨beam_sample()æ–¹æ³•
- diverse beam-search: å½“num_beams > 1ä¸”num_beam_groups > 1 è°ƒç”¨ group_beam_search()æ–¹æ³•
- constrained beam-search: å½“constraints â‰  Noneæˆ–force_words_ids â‰  None, è°ƒç”¨constrained_beam_search()æ–¹æ³•

ç¬”è€…åœ¨å®é™…æ“ä½œè¿‡ç¨‹ä¸­ï¼Œå‘ç°ä¸€äº›å‚æ•°å¯¹å®é™…ç”Ÿæˆæ•ˆæœä¼šæœ‰ä¸å°‘çš„å½±å“ï¼Œæ‰€ä»¥åœ¨è®²è§£å…·ä½“çš„å‚æ•°ä¹‹å‰ï¼Œå…ˆå›é¡¾ä¸‹ä¸»è¦çš„è§£ç ç®—æ³•åŸç†ã€‚

### è‡ªå›å½’è¯­è¨€ç”Ÿæˆä»»åŠ¡

è‡ªå›å½’è¯­è¨€ç”Ÿæˆä»»åŠ¡åŸºäºå¦‚ä¸‹å‡è®¾: ä¸€ä¸ªæ–‡æœ¬åºåˆ—çš„æ¦‚ç‡åˆ†å¸ƒå¯ä»¥åˆ†è§£ä¸ºæ¯ä¸ªè¯åŸºäºå…¶ä¸Šæ–‡çš„æ¡ä»¶æ¦‚ç‡çš„ä¹˜ç§¯ã€‚

$$
P(w_{1:T}|w_0) = \prod_{t=1} ^T P(w_t|w_{1:t-1}, W_0), å…¶ä¸­w_{1:0} = \emptyset
$$


ä¸Šå¼ä¸­ï¼Œ$$w_0$$ æ˜¯åˆå§‹ä¸Šä¸‹æ–‡å•è¯åºåˆ—ã€‚æ–‡æœ¬åºåˆ—çš„é•¿åº¦ $$T$$ é€šå¸¸æ˜¯å˜çš„ï¼Œå¹¶ä¸”å¯¹åº”äºæ—¶é—´æ­¥ $$t = T$$ã€‚$$P(w_{t} | w_{1:t-1}, w_0)$$çš„è¯è¡¨ä¸­å·²åŒ…å«ç»ˆæ­¢ç¬¦(EOS)ã€‚


### Greedy Search(è´ªå¿ƒæœç´¢)


è´ªå¿ƒæœç´¢åœ¨æ¯ä¸ªæ—¶é—´æ­¥$$t$$éƒ½ç®€å•çš„é€‰æ‹©æ¦‚ç‡æœ€é«˜çš„è¯ä½œä¸ºå½“å‰è¾“å‡ºè¯: $$w_t = argmax_{w} P(w|w_{1:t-1})$$ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º


![Untitled](https://res.cloudinary.com/dsn0i1fsm/image/upload/v1692014779/blog/decoder/Untitled_tyombp.png)

ä»å•è¯$$\text{The}$$å¼€å§‹ï¼Œç®—æ³•åœ¨ç¬¬ä¸€æ­¥è´ªå¿ƒçš„é€‰æ‹©æ¡ä»¶æ¦‚ç‡æœ€é«˜çš„è¯$$\text{nice}$$ä½œä¸ºè¾“å‡ºï¼Œä¾æ¬¡å¾€åã€‚æœ€ç»ˆç”Ÿæˆçš„å•è¯åºåˆ—ä¸º$$\text{The}, \text{nice}, \text{woman}$$ï¼Œå…¶è”åˆæ¦‚ç‡ä¸º$$0.5 \times 0.4 = 0.2$$ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬è¾“å…¥æ–‡æœ¬åºåˆ—$$\text{I} \space \text{enjoy}\space \text{walking}\space\text{with}\space\text{my}\space\text{cute}\space\text{dog}$$ç»™GPT2æ¨¡å‹ï¼Œè®©æ¨¡å‹ç”Ÿæˆä¸‹æ–‡ã€‚æˆ‘ä»¬ä»¥æ­¤ä¸ºä¾‹çœ‹å¦‚ä½•åœ¨transformersä¸­ä½¿ç”¨è´ªå¿ƒæœç´¢:

```python
# encode context the generation is conditioned on
input_ids = tokenizer.encode('I enjoy walking with my cute dog', return_tensors='tf')

# generate text until the output length (which includes the context length) reaches 50
greedy_output = model.generate(input_ids, max_length=50)

print("Output:\n" + 100 * '-')
print(tokenizer.decode(greedy_output[0], skip_special_tokens=True))
```

```python
Output:
----------------------------------------------------------------------------------------------------
I enjoy walking with my cute dog, but I'm not sure if I'll ever be able to walk with my dog. I'm not sure if I'll ever be able to walk with my dog.

I'm not sure if I'll
```

æ ¹æ®ä¸Šæ–‡ç”Ÿæˆçš„å•è¯æ˜¯åˆç†çš„ï¼Œä½†**æ¨¡å‹å¾ˆå¿«å¼€å§‹è¾“å‡ºé‡å¤æ–‡æœ¬**ï¼è¿™åœ¨è¯­è¨€ç”Ÿæˆä¸­æ˜¯ä¸€ä¸ªéå¸¸æ™®éçš„é—®é¢˜ï¼Œåœ¨è´ªå¿ƒæœç´¢å’Œæ³¢æŸæœç´¢ä¸­æ›´æ˜¯å¦‚æ­¤-è¯¦è§è®ºæ–‡[1](https://arxiv.org/abs/1610.02424)ä¸è®ºæ–‡[2](https://arxiv.org/abs/1701.03185)ã€‚

è´ªå¿ƒæœç´¢çš„ä¸»è¦ç¼ºç‚¹æ˜¯å®ƒé”™è¿‡äº†éšè—åœ¨ä½æ¦‚ç‡è¯åé¢çš„é«˜æ¦‚ç‡è¯ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤º:

æ¡ä»¶æ¦‚ç‡ä¸º$$0.9$$çš„å•è¯$$\text{has}$$éšè—åœ¨å•è¯$$\text{dog}$$çš„åé¢ï¼Œè€Œ$$\text{dog}$$å› ä¸ºåœ¨$$t=1$$æ—¶æ¡ä»¶æ¦‚ç‡å€¼åªæ’ç¬¬äºŒæ‰€ä»¥æœªè¢«é€‰æ‹©ï¼Œå› æ­¤è´ªå¿ƒæœç´¢ä¼šé”™è¿‡åºåˆ—$$\text{The}\space\text{dog}\space\text{has}$$ã€‚

å¹¸å¥½å¯ä»¥ç”¨æ³¢æŸæœç´¢æ¥ç¼“è§£è¿™ä¸ªé—®é¢˜!

### æ³¢æŸæœç´¢

æ³¢æŸæœç´¢é€šè¿‡åœ¨æ¯ä¸ªæ—¶é—´æ­¥ä¿ç•™æœ€å¯èƒ½çš„nums_beamsä¸ªè¯ï¼Œå¹¶ä»ä¸­æœ€ç»ˆé€‰æ‹©å‡ºæ¦‚ç‡æœ€é«˜çš„åºåˆ—æ¥é™ä½ä¸¢å¤±æ½œåœ¨çš„é«˜æ¦‚ç‡åºåˆ—çš„é£é™©ã€‚ä»¥num_beams=2ä¸ºä¾‹:

![Untitled](https://res.cloudinary.com/dsn0i1fsm/image/upload/v1692014779/blog/decoder/Untitled_1_ibjkje.png)

åœ¨æ—¶é—´æ­¥1ï¼Œé™¤äº†æœ€æœ‰å¯èƒ½çš„å‡è®¾$$\text{The}\space\text{nice}$$ï¼Œæ³¢æŸæœç´¢è¿˜è·Ÿè¸ªç¬¬äºŒå¯èƒ½çš„å‡è®¾$$\text{The}\space\text{dog}ã€‚$$åœ¨æ—¶é—´æ­¥2ï¼Œæ³¢æŸæœç´¢å‘ç°åºåˆ—$$\text{The}\space\text{dog}\space\text{has}$$æ¦‚ç‡ä¸º$$0.36$$ï¼Œæ¯”$$\text{The}\space\text{nice}\space\text{woman}$$çš„$$0.2$$æ›´é«˜ã€‚åœ¨æ­¤ä¾‹ä¸­ï¼Œå®ƒå·²ç»æ‰¾åˆ°äº†æœ€æœ‰å¯èƒ½çš„åºåˆ—ã€‚

æ³¢æŸæœç´¢ä¸€èˆ¬éƒ½ä¼šæ‰¾åˆ°æ¯”è´ªå¿ƒæœç´¢æ¦‚ç‡æ›´é«˜çš„è¾“å‡ºåºåˆ—ï¼Œä½†ä»ä¸ä¿è¯æ‰¾åˆ°å…¨å±€æœ€ä¼˜è§£ã€‚

æˆ‘ä»¬è®¾ç½®num_beams > 1å’Œearly_stopping = Trueä»¥ä¾¿åœ¨æ‰€æœ‰æ³¢æŸè¾¾åˆ°EOSæ—¶ç›´æ¥ç»“æŸç”Ÿæˆã€‚

```python
# activate beam search and early_stopping
beam_output = model.generate(
    input_ids, 
    max_length=50, 
    num_beams=5, 
    early_stopping=True
)

print("Output:\n" + 100 * '-')
print(tokenizer.decode(beam_output[0], skip_special_tokens=True))
```

```python
Output:
----------------------------------------------------------------------------------------------------
I enjoy walking with my cute dog, but I'm not sure if I'll ever be able to walk with him again.

I'm not sure if I'll ever be able to walk with him again. I'm not sure if I'll
```

è™½ç„¶ç»“æœæ¯”è´ªå¿ƒæœç´¢æ›´æµç•…ï¼Œä½†è¾“å‡ºä¸­ä»ç„¶åŒ…å«é‡å¤ã€‚ä¸€ä¸ªç®€å•çš„è¡¥æ•‘æªæ–½æ˜¯å¼•å…¥$$n-grams$$ï¼ˆå³è¿ç»­nä¸ªè¯çš„è¯åºåˆ—ï¼‰æƒ©ç½šï¼Œè¯¥æ–¹æ³•æ˜¯ç”±[Paulus(2017)](https://arxiv.org/abs/1705.04304)å’Œ[Klein(2017)](https://arxiv.org/abs/1705.04304)å¼•å…¥çš„ã€‚æœ€å¸¸è§çš„n-gramsæƒ©ç½šæ˜¯ç¡®ä¿æ¯ä¸ªn-graméƒ½åªå‡ºç°ä¸€æ¬¡ï¼Œæ–¹æ³•æ˜¯å¦‚æœçœ‹åˆ°å½“å‰å€™é€‰è¯ä¸å…¶ä¸Šæ–‡æ‰€ç»„æˆçš„n-gramå·²ç»å‡ºç°è¿‡äº†ï¼Œå°±å°†è¯¥å€™é€‰è¯çš„æ¦‚ç‡è®¾ç½®ä¸º0ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®no_repeat_ngram_size = 2æ¥è¯•è¯•ï¼Œè¿™æ ·ä»»æ„2-gramä¸ä¼šå‡ºç°ä¸¤æ¬¡:

```python
# set no_repeat_ngram_size to 2
beam_output = model.generate(
    input_ids, 
    max_length=50, 
    num_beams=5, 
    no_repeat_ngram_size=2, 
    early_stopping=True
)

print("Output:\n" + 100 * '-')
print(tokenizer.decode(beam_output[0], skip_special_tokens=True))
```

```python
Output:
----------------------------------------------------------------------------------------------------
I enjoy walking with my cute dog, but I'm not sure if I'll ever be able to walk with him again.

I've been thinking about this for a while now, and I think it's time for me to take a break
```

æˆ‘ä»¬çœ‹åˆ°ç”Ÿæˆçš„æ–‡æœ¬å·²ç»æ²¡æœ‰é‡å¤äº†ã€‚ä½†æ˜¯ï¼Œn-gramæƒ©ç½šä½¿ç”¨æ—¶å¿…é¡»è°¨æ…ï¼Œä¾‹å¦‚åŒ…å«åœ°åçš„æ–‡ç« é‡Œå°±ä¸åº”è¯¥ä½¿ç”¨2-gramæƒ©ç½šï¼Œå¦åˆ™ï¼ŒåŸå¸‚åç§°åœ¨æ•´ä¸ªæ–‡æœ¬ä¸­å°†åªå‡ºç°ä¸€æ¬¡ã€‚

åœ¨transformersä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦å°†å‚æ•°num_return_sequencesè®¾ç½®ä¸ºéœ€è¿”å›çš„æ¦‚ç‡æœ€é«˜çš„æ³¢æŸçš„æ•°é‡ï¼Œè®°å¾—ç¡®ä¿num_return_sequences â‰¤ num_beams !

```python
# set return_num_sequences > 1
beam_outputs = model.generate(
    input_ids, 
    max_length=50, 
    num_beams=5, 
    no_repeat_ngram_size=2, 
    num_return_sequences=5, 
    early_stopping=True
)

# now we have 3 output sequences
print("Output:\n" + 100 * '-')
for i, beam_output in enumerate(beam_outputs):
  print("{}: {}".format(i, tokenizer.decode(beam_output, skip_special_tokens=True)))
```

```python
Output:
----------------------------------------------------------------------------------------------------
0: I enjoy walking with my cute dog, but I'm not sure if I'll ever be able to walk with him again.

I've been thinking about this for a while now, and I think it's time for me to take a break
1: I enjoy walking with my cute dog, but I'm not sure if I'll ever be able to walk with him again.

I've been thinking about this for a while now, and I think it's time for me to get back to
2: I enjoy walking with my cute dog, but I'm not sure if I'll ever be able to walk with her again.

I've been thinking about this for a while now, and I think it's time for me to take a break
3: I enjoy walking with my cute dog, but I'm not sure if I'll ever be able to walk with her again.

I've been thinking about this for a while now, and I think it's time for me to get back to
4: I enjoy walking with my cute dog, but I'm not sure if I'll ever be able to walk with him again.

I've been thinking about this for a while now, and I think it's time for me to take a step
```

å¯è§ï¼Œäº”ä¸ªæ³¢æŸå½¼æ­¤ä¹‹é—´ä»…æœ‰å°‘é‡å·®åˆ« â€”â€”â€”è¿™åœ¨ä»…ä½¿ç”¨5ä¸ªæ³¢æŸæ—¶ä¸è¶³ä¸ºå¥‡ã€‚

å¼€æ”¾åŸŸæ–‡æœ¬ç”Ÿæˆçš„ç ”ç©¶äººå‘˜æœ€è¿‘æå‡ºäº†å‡ ä¸ªç†ç”±æ¥è¯´æ˜å¯¹è¯¥é¢†åŸŸè€Œè¨€æ³¢æŸæœç´¢å¯èƒ½ä¸æ˜¯æœ€ä½³æ–¹æ¡ˆ: 

- åœ¨æœºå™¨ç¿»è¯‘æˆ–æ‘˜è¦ç­‰ä»»åŠ¡ä¸­ï¼Œå› ä¸ºæ‰€éœ€ç”Ÿæˆçš„é•¿åº¦æˆ–å¤šæˆ–å°‘éƒ½æ˜¯å¯é¢„æµ‹çš„ï¼Œæ‰€ä»¥æ³¢æŸæœç´¢æ•ˆæœæ¯”è¾ƒå¥½â€”â€”å‚è§[Murray(2018)](https://arxiv.org/abs/1808.10006)å’Œ[Yang(2018)](https://arxiv.org/abs/1808.09582)çš„å·¥ä½œã€‚ä½†å¼€æ”¾åŸŸæ–‡æœ¬ç”Ÿæˆæƒ…å†µæœ‰æ‰€ä¸åŒï¼Œå…¶è¾“å‡ºæ–‡æœ¬é•¿åº¦å¯èƒ½ä¼šæœ‰å¾ˆå¤§å·®å¼‚ï¼Œå¦‚å¯¹è¯å’Œæ•…äº‹ç”Ÿæˆçš„è¾“å‡ºæ–‡æœ¬é•¿åº¦å°±æœ‰å¾ˆå¤§ä¸åŒã€‚
- æˆ‘ä»¬å·²ç»çœ‹åˆ°æ³¢æŸæœç´¢å·²è¢«è¯æ˜å­˜åœ¨é‡å¤ç”Ÿæˆçš„é—®é¢˜ã€‚åœ¨æ•…äº‹ç”Ÿæˆè¿™æ ·çš„åœºæ™¯ä¸­ï¼Œå¾ˆéš¾ç”¨n-gramæˆ–å…¶ä»–æƒ©ç½šæ¥æ§åˆ¶ï¼Œå› ä¸ºåœ¨â€ä¸é‡å¤â€å’Œæœ€å¤§å¯é‡å¤n-gramsä¹‹é—´æ‰¾åˆ°ä¸€ä¸ªå¥½çš„æŠ˜è¡·éœ€è¦å¤§é‡çš„å¾®è°ƒ
- æ­£å¦‚[Ari Holtzman(2019)](https://arxiv.org/abs/1904.09751)æ‰€è®ºè¯çš„é‚£æ ·ï¼Œé«˜è´¨é‡çš„äººç±»è¯­è¨€å¹¶ä¸éµå¾ªæœ€å¤§æ¦‚ç‡æ³•åˆ™ã€‚æ¢å¥è¯è¯´ï¼Œä½œä¸ºäººç±»ï¼Œæˆ‘ä»¬å¸Œæœ›ç”Ÿæˆçš„æ–‡æœ¬èƒ½è®©æˆ‘ä»¬æ„Ÿåˆ°æƒŠå–œï¼Œè€Œå¯é¢„æµ‹çš„æ–‡æœ¬ä½¿äººæ„Ÿåˆ°æ— èŠã€‚è®ºæ–‡ä½œè€…ç”»äº†ä¸€ä¸ªæ¦‚ç‡å›¾ï¼Œå¾ˆå¥½çš„å±•ç¤ºäº†è¿™ä¸€ç‚¹ï¼Œä»å›¾ä¸­å¯ä»¥çœ‹å‡ºäººç±»æ–‡æœ¬å¸¦æ¥çš„æƒŠå–œåº¦æ¯”æ³¢æŸæœç´¢å¥½ä¸å°‘ã€‚

![Untitled](https://res.cloudinary.com/dsn0i1fsm/image/upload/v1692014779/blog/decoder/Untitled_2_dcizxw.png)

å› æ­¤ï¼Œè®©æˆ‘ä»¬å¼€å§‹ç©ç‚¹åˆºæ¿€çš„ï¼Œå¼•å…¥ä¸€äº›éšæœºæ€§ğŸ¤ªã€‚

### é‡‡æ ·

åœ¨å…¶æœ€åŸºæœ¬çš„å½¢å¼ä¸­ï¼Œé‡‡æ ·æ„å‘³ç€æ ¹æ®å½“å‰æ¡ä»¶æ¦‚ç‡åˆ†å¸ƒéšæœºé€‰æ‹©è¾“å‡ºè¯$$w_t$$ã€‚

$$
w_t \sim P(w|w_{1:t-1})
$$

ç»§ç»­ä½¿ç”¨ä¸Šæ–‡ä¸­çš„ä¾‹å­ï¼Œä¸‹å›¾å¯è§†åŒ–äº†ä½¿ç”¨é‡‡æ ·ç”Ÿæˆæ–‡æœ¬çš„è¿‡ç¨‹ã€‚

![Untitled](https://res.cloudinary.com/dsn0i1fsm/image/upload/v1692014779/blog/decoder/Untitled_3_ylutyz.png)


å¾ˆæ˜æ˜¾ï¼Œä½¿ç”¨é‡‡æ ·æ–¹æ³•æ—¶æ–‡æœ¬ç”Ÿæˆæœ¬èº«ä¸å†æ˜¯ç¡®å®šæ€§çš„ã€‚å•è¯$$\text{car}$$ä»æ¡ä»¶æ¦‚ç‡åˆ†å¸ƒ$$P(w|\text{The})$$ä¸­é‡‡æ ·è€Œå¾—ï¼Œè€Œ$$\text{drives}$$åˆ™é‡‡æ ·è‡ª$$P(w|\text{The}\space\text{car})$$ã€‚


åœ¨transformersä¸­ï¼Œæˆ‘ä»¬è®¾ç½®do_sample=Trueå¹¶é€šè¿‡è®¾ç½®top_k=0åœç”¨Top-Ké‡‡æ ·(ç¨åè¯¦ç»†ä»‹ç»)ã€‚åœ¨ä¸‹æ–‡ä¸­ï¼Œä¸ºä¾¿äºå¤ç°ï¼Œæˆ‘ä»¬ä¼šå›ºå®šrandom_seed=0ï¼Œä½†ä½ å¯ä»¥åœ¨è‡ªå·±çš„æ¨¡å‹ä¸­éšæ„æ›´æ”¹random_seedã€‚

```jsx
# set seed to reproduce results. Feel free to change the seed though to get different results
tf.random.set_seed(0)

# activate sampling and deactivate top_k by setting top_k sampling to 0
sample_output = model.generate(
    input_ids, 
    do_sample=True, 
    max_length=50, 
    top_k=0
)

print("Output:\n" + 100 * '-')
print(tokenizer.decode(sample_output[0], skip_special_tokens=True))
```

```jsx
Output:
----------------------------------------------------------------------------------------------------
I enjoy walking with my cute dog. He just gave me a whole new hand sense."

But it seems that the dogs have learned a lot from teasing at the local batte harness once they take on the outside.

"I take
```

ç”Ÿæˆçš„æ–‡æœ¬çœ‹èµ·æ¥ä¸é”™ï½ä½†ä»”ç»†è§‚å¯Ÿä¼šå‘ç°å®ƒä¸æ˜¯å¾ˆè¿è´¯ã€‚3-grams new hand sceneå’Œlocal batte harness éå¸¸å¥‡æ€ªï¼Œçœ‹èµ·æ¥ä¸åƒæ˜¯äººå†™çš„ã€‚è¿™å°±æ˜¯å¯¹å•è¯åºåˆ—è¿›è¡Œé‡‡æ ·æ—¶çš„å¤§é—®é¢˜ï¼šæ¨¡å‹é€šå¸¸ä¼šäº§ç”Ÿä¸è¿è´¯çš„ä¹±ç ï¼Œå‚è§[Ari Holtzman(2019)](https://arxiv.org/abs/1904.09751)çš„è®ºæ–‡ã€‚

ç¼“è§£è¿™ä¸€é—®é¢˜çš„ä¸€ä¸ªæŠ€å·§æ˜¯é€šè¿‡é™ä½æ‰€è°“çš„softmaxçš„æ¸©åº¦ä½¿åˆ†å¸ƒ $$P(w|w_{1:t-1})$$ æ›´é™¡å³­ã€‚è€Œé™ä½â€œæ¸©åº¦â€ï¼Œæœ¬è´¨ä¸Šæ˜¯å¢åŠ é«˜æ¦‚ç‡å•è¯çš„ä¼¼ç„¶å¹¶é™ä½ä½æ¦‚ç‡å•è¯çš„ä¼¼ç„¶ã€‚

å°†æ¸©åº¦åº”ç”¨åˆ°äºæˆ‘ä»¬çš„ä¾‹å­ä¸­åï¼Œç»“æœå¦‚ä¸‹å›¾æ‰€ç¤º:

![Untitled](https://res.cloudinary.com/dsn0i1fsm/image/upload/v1692014779/blog/decoder/Untitled_4_k7lqeq.png)

$$t=1$$çš„æ—¶åˆ»å•è¯çš„æ¡ä»¶åˆ†å¸ƒå˜å¾—æ›´åŠ é™¡å³­ï¼Œå‡ ä¹æ²¡æœ‰æœºä¼šé€‰æ‹©å•è¯$$\text{car}$$äº†ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•é€šè¿‡è®¾ç½®temperature=0.7æ¥å†·å´ç”Ÿæˆè¿‡ç¨‹ï¼š

```jsx
# set seed to reproduce results. Feel free to change the seed though to get different results
tf.random.set_seed(0)

# use temperature to decrease the sensitivity to low probability candidates
sample_output = model.generate(
    input_ids, 
    do_sample=True, 
    max_length=50, 
    top_k=0, 
    temperature=0.7
)

print("Output:\n" + 100 * '-')
print(tokenizer.decode(sample_output[0], skip_special_tokens=True))
```

å¯ä»¥çœ‹åˆ°ï¼Œå¥‡æ€ªçš„n-gramå˜å°‘äº†ï¼Œç°åœ¨è¾“å‡ºæ›´è¿è´¯äº†ã€‚è™½ç„¶æ¸©åº¦å¯ä»¥ä½¿åˆ†å¸ƒçš„éšæœºæ€§é™ä½ï¼Œä½†æé™æ¡ä»¶ä¸‹ï¼Œå½“â€œæ¸©åº¦â€è®¾ç½®ä¸º0æ—¶ï¼Œæ¸©åº¦ç¼©æ”¾é‡‡æ ·å°±é€€åŒ–æˆè´ªå¿ƒè§£ç äº†ï¼Œå› æ­¤ä¼šé‡åˆ°ä¸è´ªå¿ƒè§£ç ç›¸åŒçš„é—®é¢˜ã€‚

### Top-Ké‡‡æ ·

[Fan(2018)](https://arxiv.org/pdf/1805.04833.pdf)ç­‰äººçš„è®ºæ–‡ä»‹ç»äº†ä¸€ç§ç®€å•ä½†éå¸¸å¼ºå¤§çš„é‡‡æ ·æ–¹æ¡ˆï¼Œæˆä¸º**Top-K**é‡‡æ ·ã€‚åœ¨**Top-K**é‡‡æ ·ä¸­ï¼Œæ¦‚ç‡æœ€å¤§çš„Kä¸ªå•è¯ä¼šè¢«é€‰å‡ºï¼Œç„¶åè¿™Kä¸ªè¯çš„æ¦‚ç‡ä¼šè¢«é‡æ–°å½’ä¸€åŒ–ï¼Œæœ€åå°±åœ¨è¿™é‡æ–°è¢«å½’ä¸€åŒ–æ¦‚ç‡åçš„Kä¸ªè¯ä¸­é‡‡æ ·ã€‚GPT2é‡‡ç”¨äº†è¿™ç§æ–¹æ¡ˆï¼Œè¿™ä¹Ÿæ˜¯å®ƒåœ¨æ•…äº‹ç”Ÿæˆè¿™æ ·çš„ä»»åŠ¡ä¸Šå–å¾—æˆåŠŸçš„åŸå› ä¹‹ä¸€ã€‚

æˆ‘ä»¬å°†ä¸Šæ–‡ä¾‹å­ä¸­çš„å€™é€‰å•è¯æ•°ä»3ä¸ªå•è¯æ‰©å±•åˆ°10ä¸ªå•è¯ï¼Œä»¥æ›´å¥½çš„è¯´æ˜**Top-K**é‡‡æ ·ã€‚

![Untitled](https://res.cloudinary.com/dsn0i1fsm/image/upload/v1692014779/blog/decoder/Untitled_5_zsjzsm.png)

è®¾$$k = 6$$ï¼Œå³æˆ‘ä»¬å°†åœ¨ä¸¤ä¸ªé‡‡æ ·æ­¥çš„é‡‡æ ·æ± å¤§å°é™åˆ¶ä¸º6ä¸ªå•è¯ã€‚æˆ‘ä»¬å®šä¹‰6ä¸ªæœ€æœ‰å¯èƒ½çš„è¯çš„é›†åˆä¸º$$V_{\text{top-K}}$$ã€‚åœ¨ç¬¬ä¸€æ­¥ä¸­ï¼Œ$$V_{\text{top-K}}$$ä»…å æ¦‚ç‡çš„å¤§çº¦ä¸‰åˆ†ä¹‹äºŒï¼Œä½†åœ¨ç¬¬äºŒæ­¥ï¼Œå®ƒå‡ ä¹å äº†å…¨éƒ¨çš„æ¦‚ç‡ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ç¬¬äºŒæ­¥è¯¥æ–¹æ³•æˆåŠŸçš„æ¶ˆé™¤äº†é‚£äº›å¥‡æ€ªçš„å€™é€‰è¯$$\text{not}ï¼Œ\text{small}ï¼Œ\text{told}$$ã€‚

æˆ‘ä»¬è®¾ç½®top_k=50ä¸ºä¾‹çœ‹ä¸‹å¦‚ä½•åœ¨transformersåº“ä¸­ä½¿ç”¨**Top-K**ï¼š

```jsx
# set seed to reproduce results. Feel free to change the seed though to get different results
tf.random.set_seed(0)

# set top_k to 50
sample_output = model.generate(
    input_ids, 
    do_sample=True, 
    max_length=50, 
    top_k=50
)

print("Output:\n" + 100 * '-')
print(tokenizer.decode(sample_output[0], skip_special_tokens=True))
```

```jsx
Output:
----------------------------------------------------------------------------------------------------
I enjoy walking with my cute dog. It's so good to have an environment where your dog is available to share with you and we'll be taking care of you.

We hope you'll find this story interesting!

I am from
```


ç›¸å½“ä¸é”™ã€‚è¯¥æ–‡æœ¬å¯ä»¥è¯´æ˜¯è¿„ä»Šä¸ºæ­¢ç”Ÿæˆçš„æœ€â€œåƒäººâ€çš„æ–‡æœ¬ã€‚ç°åœ¨è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼ŒTop-Ké‡‡æ ·ä¸ä¼šåŠ¨æ€è°ƒæ•´ä»éœ€è¦æ¦‚ç‡åˆ†å¸ƒ$$P(w|w_{1:t-1})$$ä¸­é€‰å‡ºçš„å•è¯ã€‚è¿™å¯èƒ½ä¼šæœ‰é—®é¢˜ï¼Œå› ä¸ºæŸäº›åˆ†å¸ƒå¯èƒ½æ˜¯éå¸¸å°–é”ï¼ˆä¸Šå›¾ä¸­å³ä¾§çš„åˆ†å¸ƒï¼‰ï¼Œè€Œå¦ä¸€äº›å¯èƒ½æ›´å¹³å¦ï¼ˆä¸Šå›¾ä¸­å·¦ä¾§çš„åˆ†å¸ƒï¼‰ï¼Œæ‰€ä»¥å¯¹ä¸åŒçš„åˆ†å¸ƒä½¿ç”¨åŒä¸€ä¸ªç»å¯¹æ•°$$K$$å¯èƒ½å¹¶ä¸æ™®é€‚ã€‚


åœ¨$$t=1$$æ—¶ï¼ŒTop-Kå°†$$\text{people}ï¼Œ\text{big}ï¼Œ\text{house}ï¼Œ\text{cat}$$æ’å‡ºäº†é‡‡æ ·æ± ï¼Œè€Œè¿™äº›è¯ä¼¼ä¹æ˜¯åˆç†çš„å€™é€‰è¯ã€‚å¦ä¸€æ–¹é¢ï¼Œåœ¨$$t=2$$æ—¶ï¼Œè¯¥æ–¹æ³•å´åˆæŠŠä¸å¤ªåˆé€‚çš„$$\text{down}ï¼Œ\text{a}$$çº³å…¥äº†é‡‡æ ·æ± ã€‚å› æ­¤ï¼Œå°†é‡‡æ ·æ± é™åˆ¶ä¸ºå›ºå®šå¤§å°Kå¯èƒ½ä¼šåœ¨åˆ†å¸ƒæ¯”è¾ƒå°–é”çš„æ—¶å€™äº§ç”Ÿèƒ¡è¨€ä¹±è¯­ï¼Œè€Œåœ¨åˆ†å¸ƒæ¯”è¾ƒå¹³å¦çš„æ—¶å€™é™åˆ¶æ¨¡å‹çš„åˆ›é€ åŠ›ã€‚è¿™ä¸€å‘ç°ä¿ƒä½¿[Ari Holtzmanï¼ˆ2019ï¼‰](https://arxiv.org/abs/1904.09751)å‘æ˜äº†**Top-Pæˆ–æ ¸-é‡‡æ ·ã€‚**


### Top-pï¼ˆæ ¸ï¼‰é‡‡æ ·

åœ¨Top-pä¸­ï¼Œé‡‡æ ·ä¸åªæ˜¯åœ¨æœ€æœ‰å¯èƒ½çš„Kä¸ªå•è¯ä¸­è¿›è¡Œï¼Œè€Œæ˜¯åœ¨ç´¯ç§¯æ¦‚ç‡è¶…è¿‡æ¦‚ç‡pçš„æœ€å°å•è¯é›†ä¸­è¿›è¡Œã€‚ç„¶ååœ¨è¿™ç»„è¯ä¸­é‡æ–°åˆ†é…æ¦‚ç‡è´¨é‡ã€‚è¿™æ ·ï¼Œè¯é›†çš„å¤§å°ï¼ˆåˆåé›†åˆä¸­çš„è¯æ•°ï¼‰å¯ä»¥æ ¹æ®ä¸‹ä¸€ä¸ªè¯çš„æ¦‚ç‡åˆ†å¸ƒåŠ¨æ€å¢åŠ å’Œå‡å°‘ã€‚

![Untitled](https://res.cloudinary.com/dsn0i1fsm/image/upload/v1692014779/blog/decoder/Untitled_6_ohntkd.png)



å‡è®¾$$p=0.92$$ï¼ŒTop-pé‡‡æ ·å¯¹å•è¯æ¦‚ç‡è¿›è¡Œé™åºæ’åˆ—å¹¶ç´¯åŠ ï¼Œç„¶åé€‰æ‹©æ¦‚ç‡å’Œé¦–æ¬¡è¶…è¿‡$$p=92%$$%çš„å•è¯é›†ä½œä¸ºé‡‡æ ·æ± ï¼Œå®šä¹‰ä¸º$$V_{\text{top-p}}$$ã€‚åœ¨$$t=1$$æ—¶$$V_{\text{top-p}}$$æœ‰9ä¸ªè¯ï¼Œè€Œåœ¨$$t=2$$æ—¶å®ƒåªéœ€è¦é€‰æ‹©å‰3ä¸ªè¯å°±è¶…è¿‡äº†$$92%$$%ã€‚å…¶å®å¾ˆç®€å•å§ï¼å¯ä»¥çœ‹å‡ºï¼Œåœ¨å•è¯æ¯”è¾ƒä¸å¯é¢„æµ‹æ—¶ï¼Œå®ƒä¿ç•™äº†æ›´å¤šçš„å€™é€‰è¯ï¼Œå¦‚$$P(w|\text{The})$$ï¼Œè€Œå½“å•è¯ä¼¼ä¹æ›´å®¹æ˜“é¢„æµ‹æ—¶ï¼Œåªä¿ç•™äº†å‡ ä¸ªå€™é€‰è¯ï¼Œå¦‚$$P(w|\text{The}ï¼Œ\text{car})$$ã€‚



æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®0 < top_p < 1æ¥æ¿€æ´»Top-pé‡‡æ ·ï¼š

```jsx
# set seed to reproduce results. Feel free to change the seed though to get different results
tf.random.set_seed(0)

# deactivate top_k sampling and sample only from 92% most likely words
sample_output = model.generate(
    input_ids, 
    do_sample=True, 
    max_length=50, 
    top_p=0.92, 
    top_k=0
)

print("Output:\n" + 100 * '-')
print(tokenizer.decode(sample_output[0], skip_special_tokens=True))
```

```jsx
Output:
----------------------------------------------------------------------------------------------------
I enjoy walking with my cute dog. He will never be the same. I watch him play.

Guys, my dog needs a name. Especially if he is found with wings.

What was that? I had a lot o
```

ä»¥ä¸Šç»“æœçœ‹èµ·æ¥æ›´æ‹ŸäººåŒ–ã€‚

è™½ç„¶ä»ç†è®ºä¸Šè®²ï¼ŒTop-pä¼¼ä¹æ¯”Top-Kæ›´åŠ ä¼˜é›…ï¼Œä½†è¿™ä¸¤ç§æ–¹æ³•åœ¨å®è·µä¸­éƒ½å¾ˆæœ‰æ•ˆã€‚Top-pä¹Ÿå¯ä»¥ä¸Top-Ké›†åˆä½¿ç”¨ï¼Œè¿™æ ·å¯ä»¥é¿å…æ’åéå¸¸ä½çš„è¯ï¼ŒåŒæ—¶å…è®¸è¿›è¡Œä¸€äº›åŠ¨æ€é€‰æ‹©ã€‚

æœ€åï¼Œå¦‚æœæƒ³è¦è·å¾—å¤šä¸ªç‹¬ç«‹é‡‡æ ·çš„è¾“å‡ºï¼Œæˆ‘ä»¬å¯ä»¥å†æ¬¡è®¾ç½®å‚æ•°num_return_sequences > 1:

```jsx
# set seed to reproduce results. Feel free to change the seed though to get different results
tf.random.set_seed(0)

# set top_k = 50 and set top_p = 0.95 and num_return_sequences = 3
sample_outputs = model.generate(
    input_ids,
    do_sample=True,
    max_length=50,
    top_k=50,
    top_p=0.95,
    num_return_sequences=3
)

print("Output:\n" + 100 * '-')
for i, sample_output in enumerate(sample_outputs):
  print("{}: {}".format(i, tokenizer.decode(sample_output, skip_special_tokens=True)))
```

```jsx
Output:
----------------------------------------------------------------------------------------------------
0: I enjoy walking with my cute dog. It's so good to have the chance to walk with a dog. But I have this problem with the dog and how he's always looking at us and always trying to make me see that I can do something
1: I enjoy walking with my cute dog, she loves taking trips to different places on the planet, even in the desert! The world isn't big enough for us to travel by the bus with our beloved pup, but that's where I find my love
2: I enjoy walking with my cute dog and playing with our kids," said David J. Smith, director of the Humane Society of the US.

"So as a result, I've got more work in my time," he said.
```

### æ€»ç»“

åœ¨å¼€æ”¾åŸŸè¯­è¨€ç”Ÿæˆåœºæ™¯ä¸­ï¼Œä½œä¸ºæœ€æ–°çš„è§£ç æ–¹æ³•ï¼ŒÂ *top-p*Â å’ŒÂ *top-K*Â é‡‡æ ·äºä¼ ç»Ÿçš„Â *è´ªå¿ƒ*Â å’ŒÂ *æ³¢æŸ*Â æœç´¢ç›¸æ¯”ï¼Œä¼¼ä¹èƒ½äº§ç”Ÿæ›´æµç•…çš„æ–‡æœ¬ã€‚ä½†ï¼Œæœ€è¿‘æœ‰æ›´å¤šçš„è¯æ®è¡¨æ˜Â *è´ªå¿ƒ*Â å’ŒÂ *æ³¢æŸ*Â æœç´¢çš„æ˜æ˜¾ç¼ºé™· - ä¸»è¦æ˜¯ç”Ÿæˆé‡å¤çš„å•è¯åºåˆ— - æ˜¯ç”±æ¨¡å‹ (ç‰¹åˆ«æ˜¯æ¨¡å‹çš„è®­ç»ƒæ–¹å¼) å¼•èµ·çš„ï¼Œè€Œä¸æ˜¯è§£ç æ–¹æ³•ï¼ŒÂ *å‚è§*Â **[Welleck ç­‰äºº (2019)](https://arxiv.org/pdf/1908.04319.pdf)**Â çš„è®ºæ–‡ã€‚æ­¤å¤–ï¼Œå¦‚Â **[Welleck ç­‰äºº (2020)](https://arxiv.org/abs/2002.02492)**Â çš„è®ºæ–‡æ‰€è¿°ï¼Œçœ‹èµ·æ¥Â *top-K*Â å’ŒÂ *top-p*Â é‡‡æ ·ä¹Ÿä¼šäº§ç”Ÿé‡å¤çš„å•è¯åºåˆ—ã€‚

åœ¨Â **[Welleck ç­‰äºº (2019)](https://arxiv.org/pdf/1908.04319.pdf)**Â çš„è®ºæ–‡ä¸­ï¼Œä½œè€…è¡¨æ˜ï¼Œæ ¹æ®äººç±»è¯„ä¼°ï¼Œåœ¨è°ƒæ•´è®­ç»ƒç›®æ ‡åï¼Œæ³¢æŸæœç´¢ç›¸æ¯”Â *Top-p*Â é‡‡æ ·èƒ½äº§ç”Ÿæ›´æµç•…çš„æ–‡æœ¬ã€‚

å¼€æ”¾åŸŸè¯­è¨€ç”Ÿæˆæ˜¯ä¸€ä¸ªå¿«é€Ÿå‘å±•çš„ç ”ç©¶é¢†åŸŸï¼Œè€Œä¸”é€šå¸¸æƒ…å†µä¸‹è¿™é‡Œæ²¡æœ‰æ”¾ä¹‹å››æµ·è€Œçš†å‡†çš„æ–¹æ³•ï¼Œå› æ­¤å¿…é¡»äº†è§£å“ªç§æ–¹æ³•æœ€é€‚åˆè‡ªå·±çš„ç‰¹å®šåœºæ™¯ã€‚

å¥½çš„æ–¹é¢æ˜¯ï¼ŒÂ *ä½ *Â å¯ä»¥åœ¨Â `transfomers`Â ä¸­å°è¯•æ‰€æœ‰ä¸åŒçš„è§£ç æ–¹æ³• ğŸ¤—ã€‚

ä»¥ä¸Šæ˜¯å¯¹å¦‚ä½•åœ¨Â `transformers`Â ä¸­ä½¿ç”¨ä¸åŒçš„è§£ç æ–¹æ³•ä»¥åŠå¼€æ”¾åŸŸè¯­è¨€ç”Ÿæˆçš„æœ€æ–°è¶‹åŠ¿çš„ç®€è¦ä»‹ç»ã€‚

### **é™„å½•**

`generate`Â æ–¹æ³•è¿˜æœ‰å‡ ä¸ªæ­£æ–‡æœªæåŠçš„å‚æ•°ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€è¦è§£é‡Šä¸€ä¸‹å®ƒä»¬ï¼

- `min_length`Â ç”¨äºå¼ºåˆ¶æ¨¡å‹åœ¨è¾¾åˆ°Â `min_length`Â ä¹‹å‰ä¸ç”Ÿæˆ EOSã€‚è¿™åœ¨æ‘˜è¦åœºæ™¯ä¸­ä½¿ç”¨å¾—æ¯”è¾ƒå¤šï¼Œä½†å¦‚æœç”¨æˆ·æƒ³è¦æ›´é•¿çš„æ–‡æœ¬è¾“å‡ºï¼Œä¹Ÿä¼šå¾ˆæœ‰ç”¨ã€‚
- `repetition_penalty`Â å¯ç”¨äºå¯¹ç”Ÿæˆé‡å¤çš„å•è¯è¿™ä¸€è¡Œä¸ºè¿›è¡Œæƒ©ç½šã€‚å®ƒé¦–å…ˆç”±Â **[Keskar ç­‰äºº (2019)](https://arxiv.org/abs/1909.05858)**Â å¼•å…¥ï¼Œåœ¨Â **[Welleck ç­‰äºº (2019)](https://arxiv.org/pdf/1908.04319.pdf)**Â çš„å·¥ä½œä¸­ï¼Œå®ƒæ˜¯è®­ç»ƒç›®æ ‡çš„ä¸€éƒ¨åˆ†ã€‚å®ƒå¯ä»¥éå¸¸æœ‰æ•ˆåœ°é˜²æ­¢é‡å¤ï¼Œä½†ä¼¼ä¹å¯¹æ¨¡å‹å’Œç”¨æˆ·åœºæ™¯éå¸¸æ•æ„Ÿï¼Œå…¶ä¸­ä¸€ä¸ªä¾‹å­è§ Github ä¸Šçš„Â **[è®¨è®º](https://github.com/huggingface/transformers/pull/2303)**ã€‚
- `attention_mask`Â å¯ç”¨äºå±è”½å¡«å……ç¬¦ã€‚
- `pad_token_id`ã€`bos_token_id`ã€`eos_token_id`: å¦‚æœæ¨¡å‹é»˜è®¤æ²¡æœ‰è¿™äº› tokenï¼Œç”¨æˆ·å¯ä»¥æ‰‹åŠ¨é€‰æ‹©å…¶ä»– token id æ¥è¡¨ç¤ºå®ƒä»¬ã€‚

æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥é˜…Â `generate`Â å‡½æ•°Â **[æ‰‹å†Œ](https://huggingface.co/transformers/main_classes/model.html?highlight=generate#transformers.TFPreTrainedModel.generate)**ã€‚